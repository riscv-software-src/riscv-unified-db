# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.
# SPDX-License-Identifier: BSD-3-Clause-Clear

# This workflow runs when:
#   (a) A PR changes (the regression tests)
#   (b) A PR reaches the head of the merge queue, and
#   (c) After a PR has been pushed to main
#
# However, it does something different in each case:
#   (a) All jobs are no-ops
#   (b) All jobs run, but output is not uploaded/GitHub pages is not updated
#   (c) All jobs run, results are uploaded, and GitHub pages is updated

name: Merge Queue Tests
permissions:
  contents: read
  pull-requests: write
on:
  merge_group:
    types: [checks_requested]
  workflow_dispatch:
  workflow_call:
    inputs:
      dry-run:
        required: true
        type: boolean
  push:
    branches:
      - main
env:
  SINGULARITY: 1
  DEPLOY_DIR: _site
jobs:
  build-reuse-manifest:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: run reuse
        run: ./bin/reuse spdx -o reuse_bom
      - name: Upload Reuse Manifest
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: reuse-manifest-${{ github.run_id }}
          path: reuse_bom
          retention-days: 1
  build-udb-api-doc:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate UDB API Docs
        run: ./do gen:udb:api_doc
      - name: Upload UDB API Docs
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: udb-api-${{ github.run_id }}
          path: gen/udb_api_doc
          include-hidden-files: true
          retention-days: 1
  resolve-unconfig:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Resolve unconfig
        run: ./do gen:resolved_arch
      - name: Tar unconfig
        run: tar czf gen/resolved_spec/_/resolved_spec.tar.gz gen/resolved_spec/_
      - name: Upload resolved spec
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: resolved-spec-${{ github.run_id }}
          path: gen/resolved_spec/_
          include-hidden-files: true
          retention-days: 1
  build-isa-explorer-csr:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate ISA Explorer CSR
        run: ./do gen:isa_explorer_browser_csr
      - name: Upload ISA Explorer CSR
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: isa-explorer-csr-${{ github.run_id }}
          path: gen/isa_explorer/browser
          retention-days: 1
  build-isa-explorer-ext:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate ISA Explorer Extension
        run: ./do gen:isa_explorer_browser_ext
      - name: Upload ISA Explorer Extension
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: isa-explorer-ext-${{ github.run_id }}
          path: gen/isa_explorer/browser
          retention-days: 1
  build-isa-explorer-inst:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate ISA Explorer Instructions
        run: ./do gen:isa_explorer_browser_inst
      - name: Upload ISA Explorer Instructions
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: isa-explorer-inst-${{ github.run_id }}
          path: gen/isa_explorer/browser
          retention-days: 1
  build-isa-explorer-spreadsheet:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate ISA Explorer Spreadsheet
        run: ./do gen:isa_explorer_spreadsheet
      - name: Upload ISA Explorer Spreadsheet
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: isa-explorer-spreadsheet-${{ github.run_id }}
          path: gen/isa_explorer/browser
  build-html-isa-manual:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    env:
      MANUAL_NAME: isa
      VERSIONS: all
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate HTML ISA manual
        run: ./do gen:html_manual
      - name: Upload HTML ISA manual
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: isa-html-manual-${{ github.run_id }}
          path: gen/manual/isa/top/all/html
  build-html-cfg-isa-manual:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate HTML ISA manual for a config
        run: ./do gen:html[example_rv64_with_overlay]
      - name: Upload HTML ISA manual for a config
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: cfg-html-manual-${{ github.run_id }}
          path: gen/cfg_html_doc/example_rv64_with_overlay/html
  build-instruction-appendix:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate instruction appendix
        run: ./do gen:instruction_appendix
      - name: Upload instruction appendix
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: inst-appendix-${{ github.run_id }}
          path: gen/instructions_appendix/instructions_appendix.pdf
  build-rvi20-profile:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVI20
        run: ./do gen:profile_release_pdf[RVI20]
      - name: Upload RVI20
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rvi20-${{ github.run_id }}
          path: gen/proc_crd/pdf/RVI20ProfileRelease.pdf
  build-rva20-profile:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVA20
        run: ./do gen:profile_release_pdf[RVA20]
      - name: Upload RVA20
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rva20-${{ github.run_id }}
          path: gen/proc_crd/pdf/RVA20ProfileRelease.pdf
  build-rva22-profile:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVA22
        run: ./do gen:profile_release_pdf[RVA22]
      - name: Upload RVA22
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rva22-${{ github.run_id }}
          path: gen/proc_crd/pdf/RVA22ProfileRelease.pdf
  build-rva23-profile:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVA23
        run: ./do gen:profile_release_pdf[RVA23]
      - name: Upload RVA23
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rva23-${{ github.run_id }}
          path: gen/proc_crd/pdf/RVA23ProfileRelease.pdf
  build-rvb23-profile:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVB23
        run: ./do gen:profile_release_pdf[RVB23]
      - name: Upload RVB23
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rvb23-${{ github.run_id }}
          path: gen/proc_crd/pdf/RVB23ProfileRelease.pdf
  build-ac100-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate AC100 CRD
        run: ./do gen:proc_crd_pdf[AC100]
      - name: Upload AC100 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: ac100-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/AC100-CRD.pdf
  build-ac200-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate AC200 CRD
        run: ./do gen:proc_crd_pdf[AC200]
      - name: Upload AC200 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: ac100-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/AC200-CRD.pdf
  build-mc100-32-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC100-32 CRD
        run: ./do gen:proc_crd_pdf[MC100-32]
      - name: Upload MC100-32 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc100-32-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/MC100-32-CRD.pdf
  build-mc100-64-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC100-64 CRD
        run: ./do gen:proc_crd_pdf[MC100-64]
      - name: Upload MC100-64 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc100-64-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/MC100-64-CRD.pdf
  build-mc200-32-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC200-32 CRD
        run: ./do gen:proc_crd_pdf[MC200-32]
      - name: Upload MC200-32 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc200-32-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/MC200-32-CRD.pdf
  build-mc200-64-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC200-64 CRD
        run: ./do gen:proc_crd_pdf[MC200-64]
      - name: Upload MC200-64 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc200-64-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/MC200-64-CRD.pdf
  build-mc300-32-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC300-32 CRD
        run: ./do gen:proc_crd_pdf[MC300-32]
      - name: Upload MC300-32 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc300-32-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/MC300-32-CRD.pdf
  build-mc300-64-crd:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC300-64 CRD
        run: ./do gen:proc_crd_pdf[MC300-64]
      - name: Upload MC300-64 CRD
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc300-64-crd-${{ github.run_id }}
          path: gen/proc_crd/pdf/MC300-64-CRD.pdf
  build-rvi20-32-ctp:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVI20-32 CTP
        run: ./do gen:proc_ctp_pdf[RVI20-32]
      - name: Upload RVI20-32 CTP
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rvi20-32-ctp-${{ github.run_id }}
          path: gen/proc_ctp/pdf/RVI20-32-CTP.pdf
  build-rvi20-64-ctp:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate RVI20-64 CTP
        run: ./do gen:proc_ctp_pdf[RVI20-64]
      - name: Upload RVI20-64 CTP
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: rvi20-64-ctp-${{ github.run_id }}
          path: gen/proc_ctp/pdf/RVI20-64-CTP.pdf
  build-mc100-32-ctp:
    if: (github.event_name == 'merge_queue') || (inputs.dry-run == false)
    runs-on: ubuntu-latest
    steps:
      - name: Clone Github Repo Action
        uses: actions/checkout@v4
      - name: singularity setup
        uses: ./.github/actions/singularity-setup
      - name: Generate MC100-32 CTP
        run: ./do gen:proc_ctp_pdf[MC100-32]
      - name: Upload MC100-32 CTP
        uses: actions/upload-artifact@v4
        if: (github.event_name == 'push') && (github.ref_name == 'main')
        with:
          name: mc100-32-ctp-${{ github.run_id }}
          path: gen/proc_ctp/pdf/MC100-32-CTP.pdf
  deploy_pages:
    if: (github.event_name == 'push') && (github.ref_name == 'main')
    runs-on: ubuntu-latest
    steps:
      - name: Make _site
        run: mkdir _site
      - name: Download reuse BOM
        uses: actions/download-artifact@v5
        with:
          name: reuse-manifest-${{ github.run_id }}
          path: _site/reuse_bom.txt
      - name: Download resolved spec
        uses: actions/download-artifact@v5
        with:
          name: resolved-spec-${{ github.run_id }}
          path: _site/resolved_spec
      - name: Download UDB API Docs
        uses: actions/download-artifact@v5
        with:
          name: udb-api-${{ github.run_id }}
          path: _site/htmls/udb_api_doc
      - name: Download ISA Explorer CSR
        uses: actions/download-artifact@v5
        with:
          name: isa_explorer-csr-${{ github.run_id }}
          path: _site/isa_explorer
      - name: Download ISA Explorer Extension
        uses: actions/download-artifact@v5
        with:
          name: isa_explorer-ext-${{ github.run_id }}
          path: _site/isa_explorer
      - name: Download ISA Explorer Inst
        uses: actions/download-artifact@v5
        with:
          name: isa_explorer-inst-${{ github.run_id }}
          path: _site/isa_explorer
      - name: Download ISA Explorer Spreadsheet
        uses: actions/download-artifact@v5
        with:
          name: isa_explorer-spreadsheet-${{ github.run_id }}
          path: _site/isa_explorer
      - name: Download HTML ISA Manual
        uses: actions/download-artifact@v5
        with:
          name: isa-html-manual-${{ github.run_id }}
          path: _site/manual
      - name: Download HTML ISA Manual
        uses: actions/download-artifact@v5
        with:
          name: cfg-html-manual-${{ github.run_id }}
          path: _site/example_cfg
      - name: Download Instruction Appendix
        uses: actions/download-artifact@v5
        with:
          name: inst-appendix-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVI20
        uses: actions/download-artifact@v5
        with:
          name: rvi20-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVA20
        uses: actions/download-artifact@v5
        with:
          name: rva20-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVA22
        uses: actions/download-artifact@v5
        with:
          name: rva22-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVA23
        uses: actions/download-artifact@v5
        with:
          name: rva23-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVB23
        uses: actions/download-artifact@v5
        with:
          name: rvb23-${{ github.run_id }}
          path: _site/pdfs
      - name: Download AC100
        uses: actions/download-artifact@v5
        with:
          name: ac100-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download AC200
        uses: actions/download-artifact@v5
        with:
          name: ac200-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC100-32
        uses: actions/download-artifact@v5
        with:
          name: mc100-32-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC100-64
        uses: actions/download-artifact@v5
        with:
          name: mc100-64-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC200-32
        uses: actions/download-artifact@v5
        with:
          name: mc200-32-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC200-64
        uses: actions/download-artifact@v5
        with:
          name: mc200-64-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC300-32
        uses: actions/download-artifact@v5
        with:
          name: mc300-32-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC300-64
        uses: actions/download-artifact@v5
        with:
          name: mc300-64-crd-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVI20-32 CTP
        uses: actions/download-artifact@v5
        with:
          name: rvi20-32-ctp-${{ github.run_id }}
          path: _site/pdfs
      - name: Download RVI20-64 CTP
        uses: actions/download-artifact@v5
        with:
          name: rvi20-64-ctp-${{ github.run_id }}
          path: _site/pdfs
      - name: Download MC100-32 CTP
        uses: actions/download-artifact@v5
        with:
          name: mc100-32-ctp-${{ github.run_id }}
          path: _site/pdfs
      - name: Create index
        env:
          PAGES_URL: https://riscv-software-src.github.io/riscv-unified-db
        run: |
          ruby -r erb -e "File.write('_site/index.html', ERB.new('tools/scripts/pages.html.erb', trim_mode: '-').result(binding))"
