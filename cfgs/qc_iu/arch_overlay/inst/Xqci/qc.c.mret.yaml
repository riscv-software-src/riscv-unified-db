# yaml-language-server: $schema=../../../schemas/inst_schema.json

$schema: inst_schema.json#
kind: instruction
name: qc.c.mret
long_name: Machine Exception Return
description: |
  Returns from an exception in M-mode.
  Instruction encoded in CI instruction format.
assembly: ""
definedBy:
  anyOf:
    - Xqci
    - Xqciint
access:
  s: never
  u: never
  vs: never
  vu: never
base: 32
encoding:
  match: "0001100100010010"
operation(): |
  CSR[mstatus].MIE = CSR[mcause].MPIE;
  CSR[mstatus].MPIE = 1'b1;
  CSR[mcause].MIE = CSR[mcause].MPIE;
  CSR[mcause].MPIE = 1'b1;
  CSR[mstatush].MDT = CSR[mcause].MPDT;
  CSR[mcause].MPDT = 0;
  CSR[mcause].MIL = CSR[mcause].MPIL;
  CSR[mcause].MPIL = 0xF;
  if (CSR[mstatush].MDT == 1'b0) {
    if (CSR[mstatus].MPP == 2'b00) {
      set_mode(PrivilegeMode::U);
    } else if (CSR[mstatus].MPP == 2'b01) {
      set_mode(PrivilegeMode::S);
    } else if (CSR[mstatus].MPP == 2'b11) {
      set_mode(PrivilegeMode::M);
    }
    CSR[mstatus].MPP = implemented?(ExtensionName::U) ? 2'b00 : 2'b11;
  }
  $pc = CSR[mepc].sw_read();
