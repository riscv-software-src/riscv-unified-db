Bootstrap: docker
From: ubuntu:24.04

# %files

#   Gemfile $HOME/
#   package.json $HOME/

%post
  export DEBIAN_FRONTEND=noninteractive

  apt-get update

  # Set up Python environment
  python3 -m venv /opt/venv
  . /opt/venv/bin/activate
  pip install --upgrade pip
  pip install --break-system-packages -r requirements.txt

  # please keep pkgs sorted
  apt-get install -y --no-install-recommends \
    build-essential \
    ruby-full \
    bundler \
    clang-format \
    clang-tidy \
    cmake \
    ditaa \
    g++ \
    gcc-riscv64-linux-gnu \
    gcc-riscv64-unknown-elf \
    gdb \
    gh \
    git \
    less \
    libc6-dev-riscv64-cross \
    libelf-dev \
    sudo \

  # Install Node.js
  curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  apt-get install -y nodejs
  npm install -g npm@latest

  # Create non-root user
  useradd -m -s /bin/bash vscode
  echo "vscode ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/vscode

    # Set up Ruby environment for non-root user
  su - vscode -c "gem install bundler"

    # Set proper permissions
  chown -R vscode:vscode /opt/venv

  # Install remaining packages
  apt-get install -y --no-install-recommends \
    libgmp-dev \
    libnewlib-dev \
    libyaml-dev \
    parallel \
    python3 \
    python3-pip \
    python3.12-venv \
    shellcheck

  # Install project dependencies as non-root user
  su - vscode -c "cd /workspaces/riscv-unified-db && npm install"
  su - vscode -c "cd /workspaces/riscv-unified-db && bundle install"

# cleanup
  apt-get clean autoclean
  apt-get autoremove -y
  rm -rf /var/lib/{apt, dpkg, cache, log}

  # cd $HOME
  # bundle install

  # npm i wavedrom-cli
  # npm i i -E  @antora/cli@3.1 @antora/site-generator@3.1 @antora/lunr-extension asciidoctor-kroki
