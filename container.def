Bootstrap: docker
From: ubuntu:24.04

%files
  requirements.txt /opt/requirements.txt
  package.json /opt/node/package.json
  package-lock.json /opt/node/package-lock.json

%post
  export DEBIAN_FRONTEND=noninteractive

  apt-get update

  # please keep pkgs sorted
  apt-get install -y --no-install-recommends \
    build-essential \
    bundler \
    clang-format \
    clang-tidy \
    cmake \
    ditaa \
    g++ \
    gcc-riscv64-linux-gnu \
    gcc-riscv64-unknown-elf \
    gdb \
    gh \
    git \
    less \
    libc6-dev-riscv64-cross \
    libelf-dev \
    libgmp-dev \
    libnewlib-dev \
    libyaml-dev \
    nodejs \
    npm \
    parallel \
    python3 \
    python3-pip \
    python3.12-venv \
    ruby \
    ruby-dev \
    shellcheck

# cleanup
  apt-get clean autoclean
  apt-get autoremove -y
  rm -rf /var/lib/{apt, dpkg, cache, log}

  # Create Python virtual environment and install packages
  /usr/bin/python3 -m venv /opt/venv
  /opt/venv/bin/pip install -r /opt/requirements.txt
  rm /opt/requirements.txt

  # Install npm packages globally in the container
  cd /opt/node
  /usr/bin/npm ci
  rm /opt/node/package.json /opt/node/package-lock.json

  # cd $HOME
  # bundle install

%environment
  export PATH="/opt/venv/bin:/opt/node/node_modules/.bin:$PATH"
  export NODE_PATH="/opt/node/node_modules"
