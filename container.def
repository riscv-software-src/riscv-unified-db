Bootstrap: docker
From: ubuntu:24.04
Stage: spython-base

%files
.ruby-version /opt/.ruby-version
requirements.txt /opt/requirements.txt
package.json /opt/node/
package-lock.json /opt/node/
.devcontainer/docker-entrypoint.sh /
%post

DEBIAN_FRONTEND=noninteractive

mkdir -p /workspace
cd /workspace

export DEBIAN_FRONTEND=noninteractive

# please keep pkgs sorted
\
apt-get update && \
apt-get install -y --no-install-recommends --fix-missing \
build-essential \
clang-format \
clang-tidy \
cmake \
curl \
ditaa \
g++ \
gcc-riscv64-linux-gnu \
gcc-riscv64-unknown-elf \
gdb \
gh \
git \
gpg \
less \
libc6-dev-riscv64-cross \
libelf-dev \
libgmp-dev \
libnewlib-dev \
libyaml-dev \
libz3-dev \
minisat \
nodejs \
npm \
parallel \
python3 \
python3-pip \
python3.12-venv \
rustc \
shellcheck \
zlib1g-dev

# build / install ruby
<<CMDS
  git clone https://github.com/rbenv/rbenv.git /opt/rbenv
  export RBENV_ROOT=/opt/.rbenv
  git clone https://github.com/rbenv/ruby-build.git "$(/opt/rbenv/bin/rbenv root)"/plugins/ruby-build
  /opt/rbenv/bin/rbenv install $(cat /opt/.ruby-version | tr -d "\n")
  /opt/rbenv/bin/rbenv global $(cat /opt/.ruby-version | tr -d "\n")
  /opt/rbenv/bin/rbenv init - > /opt/.rbenv-init
CMDS

# build/install eqntott
<<CMDS
  git clone --depth=1 https://github.com/TheProjecter/eqntott.git
  cd eqntott
  ./configure
  make && make install
  cd ..
  rm -rf eqntott
CMDS

# build/install espresso
<<CMDS
  git clone --depth=1 https://github.com/psksvp/espresso-ab-1.0.git
  cd espresso-ab-1.0
  ./configure
  make && make install
  cd ..
  rm -rf espresso-ab-1.0
CMDS

# build / install must
<<CMDS
  git clone https://github.com/jar-ben/mustool.git
  cd mustool
  git checkout 17fa9f9542a9ce05328dfccd1cd410f05f741ab3
  # mcsmus/mcsmus/control.cc is missing #include <cstdio>
  sed -i -e 's/#include <signal.h>/#include <signal.h>\n#include <cstdio>/' mcsmus/mcsmus/control.cc
  make -j
  install must -m 0777 /usr/bin/must
  cd ..
  rm -rf mustool
CMDS

apt-get clean autoclean
apt-get autoremove -y
rm -rf /var/lib/{apt,dpkg,cache,log}/*

# Create Python virtual environment and install packages
/usr/bin/python3 -m venv /opt/venv && \
/opt/venv/bin/pip install -r /opt/requirements.txt && \
rm /opt/requirements.txt
PATH="/opt/venv/bin:$PATH"

# Install npm packages globally in the container
cd /opt/node && \
/usr/bin/npm ci && \
rm /opt/node/package.json /opt/node/package-lock.json
NODE_PATH="/opt/node/node_modules"
PATH="/opt/node/node_modules/.bin:$PATH"

# Add rbenv initialization to all shells (login and interactive)
echo 'eval "$(/opt/rbenv/bin/rbenv init -)"' >> /etc/bash.bashrc && \
echo 'eval "$(/opt/rbenv/bin/rbenv init -)"' > /etc/profile.d/rbenv.sh
RBENV_ROOT=/opt/.rbenv
RUBY_YJIT_ENABLE=1

mkdir -p /workspace
cd /workspace

chmod a+x /docker-entrypoint.sh
%environment
export DEBIAN_FRONTEND=noninteractive
export PATH="/opt/venv/bin:$PATH"
export NODE_PATH="/opt/node/node_modules"
export PATH="/opt/node/node_modules/.bin:$PATH"
export RBENV_ROOT=/opt/.rbenv
export RUBY_YJIT_ENABLE=1
