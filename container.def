Bootstrap: docker
From: ubuntu:24.04

%files
  requirements.txt /opt/requirements.txt
  package.json /opt/node/package.json
  package-lock.json /opt/node/package-lock.json
  .ruby-version /opt/.ruby-version
  Gemfile /opt/Gemfile
  Gemfile.lock /opt/Gemfile.lock
  tools/ruby-gems/idlc/idlc.gemspec /opt/tools/ruby-gems/idlc/
  tools/ruby-gems/idlc/lib/gem_versions.rb /opt/tools/ruby-gems/idlc/lib/
  tools/ruby-gems/idlc/lib/gem_versions.rb /opt/tools/ruby-gems/idlc/lib/
  tools/ruby-gems/idlc/lib/idlc/version.rb /opt/tools/ruby-gems/idlc/lib/idlc/
  tools/ruby-gems/idl_highlighter/idl_highlighter.gemspec /opt/tools/ruby-gems/idl_highlighter/
  tools/ruby-gems/idl_highlighter/lib/idl_highlighter/version.rb /opt/tools/ruby-gems/idl_highlighter/lib/idl_highlighter/
  tools/ruby-gems/udb/udb.gemspec /opt/tools/ruby-gems/udb/
  tools/ruby-gems/udb/lib/gem_versions.rb /opt/tools/ruby-gems/udb/lib/
  tools/ruby-gems/udb/lib/udb/version.rb /opt/tools/ruby-gems/udb/lib/udb/
  tools/ruby-gems/udb-gen/udb-gen.gemspec /opt/tools/ruby-gems/udb-gen/
  tools/ruby-gems/udb-gen/lib/gem_versions.rb /opt/tools/ruby-gems/udb-gen/lib/
  tools/ruby-gems/udb-gen/lib/udb-gen/version.rb /opt/tools/ruby-gems/udb-gen/lib/udb-gen/
  tools/ruby-gems/udb_helpers/udb_helpers.gemspec /opt/tools/ruby-gems/udb_helpers/
  tools/ruby-gems/udb_helpers/lib/udb_helpers/version.rb /opt/tools/ruby-gems/udb_helpers/lib/udb_helpers/

%post
  export DEBIAN_FRONTEND=noninteractive

  apt-get update

  # please keep pkgs sorted
  apt-get install -y --no-install-recommends \
    build-essential \
    cargo \
    clang-format \
    clang-tidy \
    cmake \
    curl \
    ditaa \
    g++ \
    gcc-riscv64-linux-gnu \
    gcc-riscv64-unknown-elf \
    gdb \
    gh \
    git \
    gpg \
    less \
    libc6-dev-riscv64-cross \
    libelf-dev \
    libgmp-dev \
    libnewlib-dev \
    libyaml-dev \
    libz3-dev \
    minisat \
    nodejs \
    npm \
    python3 \
    python3-pip \
    python3.12-venv \
    rustc \
    shellcheck \
    zlib1g-dev

  # build / install ruby
  git clone https://github.com/rbenv/rbenv.git /opt/rbenv
  export RBENV_ROOT=/opt/.rbenv
  git clone https://github.com/rbenv/ruby-build.git "$(/opt/rbenv/bin/rbenv root)"/plugins/ruby-build
  /opt/rbenv/bin/rbenv install $(cat /opt/.ruby-version | tr -d "\n")
  /opt/rbenv/bin/rbenv global $(cat /opt/.ruby-version | tr -d "\n")
  /opt/rbenv/bin/rbenv init - > /opt/.rbenv-init
  # install gems
  eval "$(/opt/rbenv/bin/rbenv init -)"
  bundle install --gemfile /opt/Gemfile

  # build/install eqntott
  git clone --depth=1 https://github.com/TheProjecter/eqntott.git
  cd eqntott
  ./configure
  make && make install
  cd ..
  rm -rf eqntott

  # build/install espresso
  git clone --depth=1 https://github.com/psksvp/espresso-ab-1.0.git
  cd espresso-ab-1.0
  ./configure
  make && make install
  cd ..
  rm -rf espresso-ab-1.0

  # build / install must
  git clone https://github.com/jar-ben/mustool.git
  cd mustool
  git checkout 17fa9f9542a9ce05328dfccd1cd410f05f741ab3
  # mcsmus/mcsmus/control.cc is missing #include <cstdio>
  sed -i -e 's/#include <signal.h>/#include <signal.h>\n#include <cstdio>/' mcsmus/mcsmus/control.cc
  make -j
  install must -m 0777 /usr/bin/must
  cd ..
  rm -rf mustool

  # Create Python virtual environment and install packages
  /usr/bin/python3 -m venv /opt/venv
  /opt/venv/bin/pip install -r /opt/requirements.txt
  rm /opt/requirements.txt

  # Install npm packages globally in the container
  cd /opt/node
  /usr/bin/npm ci
  rm /opt/node/package.json /opt/node/package-lock.json

  # cleanup
  apt-get clean autoclean
  apt-get autoremove -y
  rm -rf /var/lib/{apt,dpkg,cache,log}

  # cd $HOME
  # bundle install

%environment
  export PATH="/opt/venv/bin:/opt/node/node_modules/.bin:$PATH"
  export NODE_PATH="/opt/node/node_modules"
  RBENV_ROOT=/opt/.rbenv
  source /opt/.rbenv-init
  export RUBY_YJIT_ENABLE=1
