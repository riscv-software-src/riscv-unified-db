#!/usr/bin/env bash

ROOT=$(dirname "$(dirname "$(realpath "${BASH_SOURCE[0]}")")")
cd "$ROOT" || exit

CONTAINER_TAG=$(cat "${ROOT}/bin/.container-tag")

# shellcheck source=.functions.sh
source "${ROOT}/bin/.functions.sh"

# Parse command line arguments
PRESERVE_CONFIG=0

# Only parse arguments if this script is being run directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  for arg in "$@"; do
    case $arg in
      --preserve-config)
        PRESERVE_CONFIG=1
        shift
        ;;
      --help|-h)
        echo "Usage: $0 [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --preserve-config    Only create .bundle/config if missing (default: always recreate)"
        echo "  --help, -h           Show this help message"
        exit 0
        ;;
      *)
        echo "Unknown option: $arg"
        echo "Use --help for usage information"
        exit 1
        ;;
    esac
  done
fi

# Supported container types:
#
# = devcontainer
#
# When devcontainer is used, all commands run "natively" (no container prefix), because it's assumed
# that the command itself is already in the container context
#
# = docker
#
# A docker container. All commands on the host (using ./do or ./bin/*) are run in the context of a Docker image.
#
# = podman
#
# A docker container run using Podman. All commands on the host (using ./do or ./bin/*) are run in the context of a Docker image.
# Podman provides a Docker-compatible CLI.
#
# = singularity
#
# An apptainer/singularity container. All commands on the host (using ./do or ./bin/*) are run in the context of an Apptainer/Singularity image.
#
#
# ALL THREE CONTAINERS ARE (in theory) IDENTICAL. Which one you use is a preference of your setup and installed
# software.

CONTAINER_TYPE=$(get_container_type)

if [ "${CONTAINER_TYPE}" != "docker" ] && [ "${CONTAINER_TYPE}" != "podman" ] && [ "${CONTAINER_TYPE}" != "singularity" ] && [ "${CONTAINER_TYPE}" != "native" ]; then
  echo "BAD CONTAINER TYPE: ${CONTAINER_TYPE}"
fi

if [ ! -f "${ROOT}/.container-type" ]; then
  echo "${CONTAINER_TYPE}" > "${ROOT}/.container-type"
fi

echo "Using ${CONTAINER_TYPE} environment"

if [ -v GITHUB_ACTIONS ] && [ "${CONTAINER_TYPE}" == "singularity" ]; then
    echo "Running in a GitHub Action"
    CONTAINER_PATH=${ROOT}/.singularity/image.sif

    # needed to get singularity working on Ubuntu 24.04
    # see https://github.com/lima-vm/lima/issues/2319
    sudo /bin/bash -c "echo \"kernel.apparmor_restrict_unprivileged_userns = 0\" >/etc/sysctl.d/99-userns.conf"
    sudo sysctl --system
elif [ "${CONTAINER_TYPE}" == "docker" ] || [ "${CONTAINER_TYPE}" == "podman" ]; then
    if ! ${CONTAINER_TYPE} images "riscvintl/udb:${CONTAINER_TAG}" | grep -q udb ; then
        echo "Image not found locally. Attempting to pull from registry..."
        if ${CONTAINER_TYPE} pull "docker.io/riscvintl/udb:${CONTAINER_TAG}" 2>/dev/null; then
            echo "Successfully pulled image from registry."
        else
            echo "Could not pull image from registry. Building locally..."
            ${CONTAINER_TYPE} build -t "riscvintl/udb:${CONTAINER_TAG}" -f .devcontainer/Dockerfile .
        fi
    fi
    if [ "${CONTAINER_TYPE}" == "podman" ]; then
      # Podman requires extra flags to handle SELinux
      SELINUX_LABEL=":z"
    else
      SELINUX_LABEL=""
    fi

    CONTAINER_RUN_FLAGS="-v ${ROOT}:${ROOT}${SELINUX_LABEL}"
    if [ -v UDB_CONTAINER_BIND ]; then
      CONTAINER_RUN_FLAGS="${CONTAINER_RUN_FLAGS} -v ${UDB_CONTAINER_BIND}:${UDB_CONTAINER_BIND}${SELINUX_LABEL}"
    fi
    if [ -f "$ROOT/.git" ]; then
        # if this is a worktree, need to add the parent git repo in, too
        GIT_PATH=$(git rev-parse --git-common-dir | tr -d '\n' | xargs dirname)
        CONTAINER_RUN_FLAGS="${CONTAINER_RUN_FLAGS} -v ${GIT_PATH}:${GIT_PATH}${SELINUX_LABEL}"
    fi
    if ! [ -v GITHUB_ACTIONS ]; then
      CONTAINER_RUN_FLAGS="${CONTAINER_RUN_FLAGS} -e HOME"
      CONTAINER_RUN_FLAGS="${CONTAINER_RUN_FLAGS} --tmpfs ${HOME}"
    fi

    # run as the host user, and copy in /etc/{passwd,group} to get the mappings
    mkdir -p "${ROOT}/.cache"
    getent passwd > "${ROOT}/.cache/passwd"
    getent group >> "${ROOT}/.cache/group"
    CONTAINER_RUN_FLAGS="${CONTAINER_RUN_FLAGS} --user $(id -u):$(id -g) -v ${ROOT}/.cache/passwd:/etc/passwd:ro -v ${ROOT}/.cache/group:/etc/group:ro"

    if [ -v PRE_COMMIT_HOME ]; then
      CONTAINER_RUN_FLAGS="${CONTAINER_RUN_FLAGS} -e PRE_COMMIT_HOME"
    fi

    if [ -t 1 ] && [ -t 0 ]; then
      CONTAINER_BASE="${CONTAINER_TYPE} run --rm -it ${CONTAINER_RUN_FLAGS} -w ${ROOT} riscvintl/udb:${CONTAINER_TAG}"
    else
      CONTAINER_BASE="${CONTAINER_TYPE} run --rm ${CONTAINER_RUN_FLAGS} -w ${ROOT} riscvintl/udb:${CONTAINER_TAG}"
    fi
elif [ "${CONTAINER_TYPE}" == "singularity" ]; then
    CONTAINER_PATH=${ROOT}/.singularity/image-$CONTAINER_TAG.sif
    if [ ! -f "${CONTAINER_PATH}" ]; then
      echo "Fetching container..."
      if [ ! -d "${ROOT}/.singularity" ]; then
        mkdir -p "${ROOT}/.singularity"
      fi
      singularity pull "${CONTAINER_PATH}" "oras://docker.io/riscvintl/spec-generator:$CONTAINER_TAG"
    fi
    if [ -v UDB_CONTAINER_BIND ]; then
      EXTRA_BIND="--bind ${UDB_CONTAINER_BIND}:${UDB_CONTAINER_BIND}"
    fi
elif [ "${CONTAINER_TYPE}" != "native" ]; then
    echo "Bad container type: ${CONTAINER_TYPE}" 1>&2
    exit 1
fi

if [ "${CONTAINER_TYPE}" == "native" ]; then
    RUN=""
elif [ "${CONTAINER_TYPE}" == "docker" ] || [ "${CONTAINER_TYPE}" == "podman" ]; then
    RUN="${CONTAINER_BASE}"
elif [ "${CONTAINER_TYPE}" == "singularity" ]; then
    if [ -f "$ROOT/.git" ]; then
        # if this is a worktree, need to add the parent git repo in, too
        GIT_PATH=$(git rev-parse --git-common-dir | tr -d '\n' | xargs dirname)
        GIT_BIND="--bind ${GIT_PATH}:${GIT_PATH}"
    fi
    RUN="singularity run ${GIT_BIND} ${EXTRA_BIND} ${CONTAINER_PATH}"
else
    echo "Bad container type: ${CONTAINER_TYPE}" 1>&2
    exit 1
fi

if [ ! -f "$ROOT/ext/rbi-central/README.md" ]; then
    git submodule update --init ext/rbi-central
fi

# Set executables
BUNDLE="${RUN} bundle"
RUBY="${RUN} bundle exec ruby"
RAKE="${RUN} bundle exec rake"
NPM="${RUN} npm"
NPX="${RUN} npx"
NODE="${RUN} node"
PYTHON="${RUN} /opt/venv/bin/python3"
PIP="${RUN} /opt/venv/bin/pip"
BASH="${RUN} bash"
GPP="${RUN} g++"
GDB="${RUN} gdb"
CLANG_FORMAT="${RUN} clang-format"
CLANG_TIDY="${RUN} clang-tidy"
MAKE="${RUN} make"

if [ ! -v GITHUB_ACTIONS ]; then

  git config --local commit.template ${ROOT}/.gitmessage

  GIT_REPO_ROOT=$(git rev-parse --path-format=absolute --git-common-dir | tr -d '\n')
  if [ ! -f "$GIT_REPO_ROOT/hooks/pre-commit" ]; then
    cat << HOOK > "$GIT_REPO_ROOT/hooks/pre-commit"
#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

# start templated
INSTALL_PYTHON=\$(realpath ./bin/python)
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit)
# end templated

GIT_REPO_ROOT=$(git rev-parse --show-toplevel | tr -d '\n')
HERE="$(cd "$(dirname "\$0")" && pwd)"
ARGS+=(--hook-dir "\$HERE" -- "\$@")
export PRE_COMMIT_HOME=${GIT_REPO_ROOT}/.cache

if [ -x "\$INSTALL_PYTHON" ]; then
    exec "\$INSTALL_PYTHON" -mpre_commit "\${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "\${ARGS[@]}"
else
    echo '\`pre-commit\` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
HOOK
    chmod +x "$GIT_REPO_ROOT/hooks/pre-commit"
  fi

  if [ ! -f "$GIT_REPO_ROOT/hooks/commit-msg" ]; then
    cat << HOOK > "$GIT_REPO_ROOT/hooks/commit-msg"
#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

# start templated
INSTALL_PYTHON=\$(realpath ./bin/python)
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=commit-msg)
# end templated

HERE="$(cd "$(dirname "\$0")" && pwd)"
ARGS+=(--hook-dir "\$HERE" -- "\$@")

if [ -x "\$INSTALL_PYTHON" ]; then
    exec "\$INSTALL_PYTHON" -mpre_commit "\${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "\${ARGS[@]}"
else
    echo '\`pre-commit\` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
HOOK
    chmod +x "$GIT_REPO_ROOT/hooks/commit-msg"
  fi
fi
