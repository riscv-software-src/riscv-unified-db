#!/usr/bin/env bash

ROOT=$(dirname $(dirname $(realpath ${BASH_SOURCE[0]})))
OLDWD=$PWD
cd $ROOT

CONTAINER_TAG=`cat ${ROOT}/bin/.container-tag`

# Parse command line arguments
PRESERVE_CONFIG=0

# Only parse arguments if this script is being run directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  for arg in "$@"; do
    case $arg in
      --preserve-config)
        PRESERVE_CONFIG=1
        shift
        ;;
      --help|-h)
        echo "Usage: $0 [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --preserve-config    Only create .bundle/config if missing (default: always recreate)"
        echo "  --help, -h           Show this help message"
        exit 0
        ;;
      *)
        echo "Unknown option: $arg"
        echo "Use --help for usage information"
        exit 1
        ;;
    esac
  done
fi

# Supported container types:
#
# = devcontainer
#
# When devcontainer is used, all commands run "natively" (no container prefix), because it's assumed
# that the command itself is already in the container context
#
# = docker
#
# A docker container. All commands on the host (using ./do or ./bin/*) are run in the context of a Docker image.
#
# = podman
#
# A docker container run using Podman. All commands on the host (using ./do or ./bin/*) are run in the context of a Docker image.
# Podman provides a Docker-compatible CLI.
#
# = singularity
#
# An apptainer/singularity container. All commands on the host (using ./do or ./bin/*) are run in the context of an Apptainer/Singularity image.
#
#
# ALL THREE CONTAINERS ARE (in theory) IDENTICAL. Which one you use is a preference of your setup and installed
# software.


# get the container type
#
# use, in priority order:
#  1. devcontainer, if DEVCONTAINER_ENV is set in the environment
#  2. the type stored in .container-type
#  3. Docker, if DOCKER is set in the environment
#  4. Podman, if PODMAN is set in the environment
#  5. Singularity, if SINGULARITY is set in the environment
#  6. The choice made by the user, which will be cached in .container-type
if [ -v DEVCONTAINER_ENV ]; then
CONTAINER_TYPE=devcontainer
elif [ -f ${ROOT}/.container-type ]; then
CONTAINER_TYPE=`cat ${ROOT}/.container-type`
elif [ -v DOCKER ]; then
CONTAINER_TYPE=docker
elif [ -v PODMAN ]; then
CONTAINER_TYPE=podman
elif [ -v SINGULARITY ]; then
CONTAINER_TYPE=singularity
else
  echo -e "UDB tools run in a container. Docker, Podman, and Singularity/Apptainer are supported.\\n\\n1. Docker\\n2. Podman\\n3. Singularity\\n"
  while true; do
    echo "Which would you like to use? (1/2/3) "
    read ans
    case $ans in
        [1]* ) CONTAINER_TYPE=docker; break;;
        [2]* ) CONTAINER_TYPE=podman; break;;
        [3]* ) CONTAINER_TYPE=singularity; break;;
        * ) echo -e "\\nPlease answer 1, 2, or 3.";;
    esac
  done
fi

if [ "${CONTAINER_TYPE}" != "docker" -a "${CONTAINER_TYPE}" != "podman" -a "${CONTAINER_TYPE}" != "singularity" -a "${CONTAINER_TYPE}" != "devcontainer" ]; then
  echo "BAD CONTAINER TYPE: ${CONTAINER_TYPE}"
fi

if [ ! -f ${ROOT}/.container-type ]; then
  echo ${CONTAINER_TYPE} > ${ROOT}/.container-type
fi

echo "Using ${CONTAINER_TYPE} environment"

if [ -v GITHUB_ACTIONS ]; then
    echo "Running in a GitHub Action"
    CONTAINER_PATH=${ROOT}/.singularity/image.sif
    HOME_PATH=${GITHUB_WORKSPACE}
    HOME_OPT="--home ${ROOT}/.home"
    SINGULARITY_CACHE=--disable-cache

    # needed to get singularity working on Ubuntu 24.04
    # see https://github.com/lima-vm/lima/issues/2319
    sudo /bin/bash -c "echo \"kernel.apparmor_restrict_unprivileged_userns = 0\" >/etc/sysctl.d/99-userns.conf"
    sudo sysctl --system
elif [ "${CONTAINER_TYPE}" == "docker" -o "${CONTAINER_TYPE}" == "podman" ]; then
    if ! ${CONTAINER_TYPE} images riscvintl/udb:${CONTAINER_TAG} | grep -q udb ; then
        echo "Image not found locally. Attempting to pull from registry..."
        if ${CONTAINER_TYPE} pull docker.io/riscvintl/udb:${CONTAINER_TAG} 2>/dev/null; then
            echo "Successfully pulled image from registry."
        else
            echo "Could not pull image from registry. Building locally..."
            ${CONTAINER_TYPE} build -t riscvintl/udb:${CONTAINER_TAG} -f .devcontainer/Dockerfile .
        fi
    fi
    if [ ${CONTAINER_TYPE} == "podman" ]; then
      # Podman requires extra flags to handle SELinux
      SELINUX_LABEL=":z"
    else
      SELINUX_LABEL=""
    fi
    if [ -t 1 -a -t 0 ]; then
      CONTAINER_BASE="${CONTAINER_TYPE} run --rm -it -v ${ROOT}:${ROOT}${SELINUX_LABEL} -w ${ROOT} riscvintl/udb:${CONTAINER_TAG}"
    else
      CONTAINER_BASE="${CONTAINER_TYPE} run --rm -v ${ROOT}:${ROOT}${SELINUX_LABEL} -w ${ROOT} riscvintl/udb:${CONTAINER_TAG}"
    fi
elif [ "${CONTAINER_TYPE}" == "singularity" ]; then
    CONTAINER_PATH=${ROOT}/.singularity/image-$CONTAINER_TAG.sif
    HOME_PATH=${HOME}
    HOME_OPT="--bind ${ROOT}/.home:${HOME_PATH}"
    SINGULARITY_CACHE=
    if [ ! -f ${CONTAINER_PATH} ]; then
      echo "Fetching container..."
      if [ ! -d "${ROOT}/.singularity" ]; then
        mkdir -p ${ROOT}/.singularity
      fi
      singularity pull ${SINGULARITY_CACHE} ${CONTAINER_PATH} oras://docker.io/riscvintl/spec-generator:$CONTAINER_TAG
    fi
elif [ "${CONTAINER_TYPE}" == "devcontainer" ]; then
    HOME_PATH=${HOME}
else
    echo "Bad container type: ${CONTAINER_TYPE}" 1>&2
    exit 1
fi

if [ -f $ROOT/.git ]; then
    # if this is a worktree, need to add the parent git repo in, too
    GIT_PATH=`git rev-parse --git-common-dir | tr -d '\n' | xargs dirname`
    HOME_OPT="${HOME_OPT} --bind ${GIT_PATH}:${GIT_PATH}"
fi

if [ "${CONTAINER_TYPE}" == "devcontainer" ]; then
    RUN=""
elif [ "${CONTAINER_TYPE}" == "docker" -o "${CONTAINER_TYPE}" == "podman" ]; then
    RUN="${CONTAINER_BASE}"
elif [ "${CONTAINER_TYPE}" == "singularity" ]; then
    RUN="singularity run ${HOME_OPT} ${CONTAINER_PATH}"
else
    echo "Bad container type: ${CONTAINER_TYPE}" 1>&2
    exit 1
fi

if [ ! -d $ROOT/.home ]; then
    mkdir $ROOT/.home
fi

if [ $PRESERVE_CONFIG -eq 0 ] || [ ! -f $ROOT/.bundle/config ]; then
    if [ -f $ROOT/.bundle/config ] && [ $PRESERVE_CONFIG -eq 0 ]; then
        echo "Recreating bundle config..."
    fi
    OLDDIR=$PWD
    cd $ROOT
    ${RUN} bundle config set --local path ${ROOT}/.home/.gems
    ${RUN} bundle config set --local cache_path ${ROOT}/.home/.cache
    ${RUN} bundle config set --local with development
    cd $OLDDIR
fi

if [ ! -d $ROOT/.home/.gems ]; then
    OLDDIR=$PWD
    cd $ROOT
    ${RUN} bundle install
    cd $OLDDIR
fi

if [ ! -f $ROOT/ext/rbi-central/README.md ]; then
    git submodule update --init ext/rbi-central
fi

if [ ! -d $ROOT/.home/.venv ]; then
    ${RUN} /usr/bin/python3 -m venv ${ROOT}/.home/.venv
fi

source ${ROOT}/.home/.venv/bin/activate

if [ ! -f ${ROOT}/.home/.venv/bin/pre-commit ]; then
    ${RUN} ${ROOT}/.home/.venv/bin/pip install -r requirements.txt
fi

# if [ ! -f $ROOT/ext/riscv-opcodes/README.md ]; then
#   git submodule update --init ext/riscv-opcodes
# fi

if [[ ! -z "$DEVELOPMENT" && $DEVELOPMENT -eq 1 ]]; then
    if [ ! -d "${ROOT}/.home/.yard/gem_index" ]; then
        ${RUN} bundle exec --gemfile ${ROOT}/Gemfile yard config --gem-install-yri
        ${RUN} bundle exec --gemfile ${ROOT}/Gemfile yard gems
        touch ${ROOT}/.stamps/dev_gems
    fi
fi

if [ ! -d ${ROOT}/node_modules ]; then
    ${RUN} npm i
fi

if [ "${CONTAINER_TYPE}" == "devcontainer" ]; then
    BUNDLE="bundle"
    RUBY="bundle exec ruby"
    RAKE="bundle exec rake"
    NPM="npm"
    NPX="npx"
    NODE="node"
    PYTHON="${ROOT}/.home/.venv/bin/python3"
    PIP="${ROOT}/.home/.venv/bin/pip"
    BASH="bash"
    GPP="g++"
    GDB="gdb"
    CLANG_FORMAT="clang-format"
    CLANG_TIDY="clang-tidy"
    MAKE="make"
elif [ "${CONTAINER_TYPE}" == "docker" -o "${CONTAINER_TYPE}" == "podman" ]; then
    BUNDLE="${CONTAINER_BASE} bundle"
    RUBY="${CONTAINER_BASE} bundle exec ruby"
    RAKE="${CONTAINER_BASE} bundle exec rake"
    NPM="${CONTAINER_BASE} npm"
    NPX="${CONTAINER_BASE} npx"
    NODE="${CONTAINER_BASE} node"
    PYTHON="${CONTAINER_BASE} ${ROOT}/.home/.venv/bin/python3"
    PIP="${CONTAINER_BASE} ${ROOT}/.home/.venv/bin/pip"
    BASH="${CONTAINER_BASE} bash"
    GPP="${CONTAINER_BASE} g++"
    GDB="${CONTAINER_BASE} gdb"
    CLANG_FORMAT="${CONTAINER_BASE} clang-format"
    CLANG_TIDY="${CONTAINER_BASE} clang-tidy"
    MAKE="${CONTAINER_BASE} make"
elif [ "${CONTAINER_TYPE}" == "singularity" ]; then
    BUNDLE="singularity run ${HOME_OPT} ${CONTAINER_PATH} bundle"
    RUBY="singularity run ${HOME_OPT} ${CONTAINER_PATH} bundle exec ruby"
    RAKE="singularity run ${HOME_OPT} ${CONTAINER_PATH} bundle exec rake"
    NPM="singularity run ${HOME_OPT} ${CONTAINER_PATH} npm"
    NPX="singularity run ${HOME_OPT} ${CONTAINER_PATH} npx"
    NODE="singularity run ${HOME_OPT} ${CONTAINER_PATH} node"
    PYTHON="singularity run ${HOME_OPT} ${CONTAINER_PATH} ${ROOT}/.home/.venv/bin/python3"
    PIP="singularity run ${HOME_OPT} ${CONTAINER_PATH} ${ROOT}/.home/.venv/bin/pip"
    BASH="singularity run ${HOME_OPT} ${CONTAINER_PATH} bash"
    GPP="singularity run ${HOME_OPT} ${CONTAINER_PATH} g++"
    GDB="singularity run ${HOME_OPT} ${CONTAINER_PATH} gdb"
    CLANG_FORMAT="singularity run ${HOME_OPT} ${CONTAINER_PATH} clang-format"
    CLANG_TIDY="singularity run ${HOME_OPT} ${CONTAINER_PATH} clang-tidy"
    MAKE="singularity run ${HOME_OPT} ${CONTAINER_PATH} make"
else
    echo "Bad container type: ${CONTAINER_TYPE}" 1>&2
    exit 1
fi

git config --local commit.template ${ROOT}/.gitmessage

GIT_REPO_ROOT=`git rev-parse --path-format=absolute --git-common-dir | tr -d '\n'`
if [ ! -f $GIT_REPO_ROOT/hooks/pre-commit ]; then
  cat << HOOK > $GIT_REPO_ROOT/hooks/pre-commit
#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

# start templated
INSTALL_PYTHON=\$(realpath ./bin/python)
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit)
# end templated

HERE="$(cd "$(dirname "\$0")" && pwd)"
ARGS+=(--hook-dir "\$HERE" -- "\$@")

if [ -x "\$INSTALL_PYTHON" ]; then
    exec "\$INSTALL_PYTHON" -mpre_commit "\${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "\${ARGS[@]}"
else
    echo '\`pre-commit\` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
HOOK
  chmod +x $GIT_REPO_ROOT/hooks/pre-commit
fi

if [ ! -f $GIT_REPO_ROOT/hooks/commit-msg ]; then
  cat << HOOK > $GIT_REPO_ROOT/hooks/commit-msg
#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

# start templated
INSTALL_PYTHON=\$(realpath ./bin/python)
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=commit-msg)
# end templated

HERE="$(cd "$(dirname "\$0")" && pwd)"
ARGS+=(--hook-dir "\$HERE" -- "\$@")

if [ -x "\$INSTALL_PYTHON" ]; then
    exec "\$INSTALL_PYTHON" -mpre_commit "\${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "\${ARGS[@]}"
else
    echo '\`pre-commit\` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
HOOK
  chmod +x $GIT_REPO_ROOT/hooks/commit-msg
fi
