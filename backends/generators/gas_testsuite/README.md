# GAS Testsuite Generator

This directory contains a generator for producing GNU Assembler (GAS) testsuite files for binutils from the RISC-V Unified Database instruction definitions.

## Overview

The generator produces two types of files for each extension:
- `.s` files - Assembly source files containing test instructions
- `.d` files - Expected disassembly output patterns for `objdump`

These files follow the standard binutils GAS testsuite format used in `gas/testsuite/gas/riscv/`.

## Usage

### Command Line

```bash
python generate_gas_tests.py --inst-dir=<path> --output-dir=<path> [options]
```

#### Options

| Option | Description |
|--------|-------------|
| `--inst-dir` | Directory containing instruction YAML files (required) |
| `--output-dir` | Output directory for generated test files (default: current directory) |
| `--extension`, `-e` | Generate tests only for specified extension(s). Can be repeated. |
| `--arch` | Target architecture: RV32, RV64, or BOTH (default: RV64) |
| `--include-all`, `-a` | Include all instructions, ignoring extension filtering |
| `--debug`, `-d` | Enable debug logging |

### Examples

Generate tests for all extensions:
```bash
python generate_gas_tests.py --inst-dir=../../../spec/std/isa/inst --output-dir=./output --include-all
```

Generate tests for specific extensions:
```bash
python generate_gas_tests.py --inst-dir=../../../spec/std/isa/inst --output-dir=./output --extension=Zba --extension=Zbb
```

Generate RV32 tests:
```bash
python generate_gas_tests.py --inst-dir=../../../spec/std/isa/inst --output-dir=./output --arch=RV32
```

### Using Rake

You can also use the rake task:

```bash
rake gen:gas_testsuite                           # Generate for all extensions
rake gen:gas_testsuite EXTENSION=Zba,Zbb         # Generate for specific extensions
rake gen:gas_testsuite ARCH=RV32                 # Generate for RV32
rake gen:gas_testsuite OUTPUT_DIR=/path/to/dir   # Custom output directory
```

## Output Format

### Assembly Source File (.s)

```asm
# Test file for Zba extension instructions
# Auto-generated by riscv-unified-db

target:
    add.uw  a0, a1, a2
    sh1add  a0, a1, a2
    sh1add.uw   a0, a1, a2
    ...
```

### Expected Disassembly File (.d)

```
#as: -march=rv64i_zba
#source: zba.s
#objdump: -dr

.*:[    ]+file format .*


Disassembly of section .text:

0+000 <target>:
[       ]+[0-9a-f]+:[   ]+[0-9a-f]{8}[  ]+add\.uw[      ]+.*
[       ]+[0-9a-f]+:[   ]+[0-9a-f]{8}[  ]+sh1add[       ]+.*
...
```

## Supported Extensions

The generator supports all standard RISC-V extensions defined in the Unified Database, including:

- Base extensions: I, M, A, F, D, Q, C, B, H, S, V
- Bit manipulation: Zba, Zbb, Zbc, Zbs, Zbkb, Zbkx
- Cryptography: Zkn, Zknd, Zkne, Zknh, Zks
- Floating-point: Zfa, Zfh, Zfbfmin
- Vector: Zvbb, Zvbc, Zvfbfmin, Zvfbfwma, Zvkg, Zvkned, Zvknha, Zvks
- Atomic: Zaamo, Zabha, Zacas, Zalasr, Zalrsc, Zawrs
- Compressed: Zca, Zcb, Zcd, Zcf, Zcmop, Zcmp, Zcmt
- And many more...

## Integration with binutils

The generated test files can be used directly with the binutils GAS testsuite:

1. Copy the generated `.s` and `.d` files to `gas/testsuite/gas/riscv/`
2. Run the testsuite using `make check-gas`

## Notes

- The generator automatically determines the correct `-march` string for each extension
- Operand values are generated to produce valid assembly that will assemble correctly
- The `.d` file patterns use regex to match the expected disassembly output
- Compressed instructions are detected and handled with appropriate 16-bit encoding patterns
