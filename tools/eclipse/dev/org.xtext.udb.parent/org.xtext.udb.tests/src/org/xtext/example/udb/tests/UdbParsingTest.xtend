/*
 * generated by Xtext 2.39.0
 */
package org.xtext.example.udb.tests

import com.google.inject.Inject
import org.eclipse.xtext.testing.InjectWith
import org.eclipse.xtext.testing.extensions.InjectionExtension
import org.eclipse.xtext.testing.util.ParseHelper
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Test
import org.junit.jupiter.api.^extension.ExtendWith
import org.xtext.example.udb.udb.Model

@ExtendWith(InjectionExtension)
@InjectWith(UdbInjectorProvider)
class UdbParsingTest {
	@Inject
	ParseHelper<Model> parseHelper
	
	@Test
	def void parsesValidCSR() {
		val result = parseHelper.parse('''
			kind: csr;
			name: vcsr;
			long_name: Vector Control and Status Register;
			address: 0x00F;
			writable: true;
			priv_mode: U;
			length: "MXLEN";
			description: "Contains aliases to vxrm and vxsat CSRs";
			definedBy: V;
			fields {
			  VXRM {
			    location: "2-1";
			    description: "See vxrm.";
			    type: "RW-RH";
			    alias: "vxrm.VALUE[1:0]";
			    sw_write(csr_value): "|
			      CSR[vxrm].VALUE = csr_value.VXRM;
			      return csr_value.VXRM;";
			    reset_value: "UNDEFINED_LEGAL";
			  }
			  VXSAT {
			    location: "0";
			    description: "See vxsat.";
			    type: "RW-RH";
			    alias: "vxsat.VALUE[0]";
			    sw_write(csr_value): "|
			      CSR[vxsat].VALUE = csr_value.VXSAT;
			      return csr_value.VXSAT;";
			    reset_value: "UNDEFINED_LEGAL";
			  }
			}
			
		''')
		Assertions.assertNotNull(result)
		val errors = result.eResource.errors
		Assertions.assertTrue(errors.isEmpty, '''Unexpected errors: «errors.join(", ")»''')
		
		
		// check basic inputs
		var k = result.kind.get(0);
		//Assertions.assertEquals("csr", k.getKind()); // testing enums isnt quite working t
		var n = result.csrName.get(0);
		Assertions.assertEquals("vcsr", n.getName());
		var ln = result.longname.get(0);
		Assertions.assertEquals("Vector Control and Status Register", ln.getLong_name());
		var add = result.address.get(0);
		Assertions.assertEquals("0x00F", add.getAddress());
		var writ = result.writable.get(0);
		Assertions.assertEquals(true, writ.isWritable()); // what
		var priv = result.privmode.get(0);
		Assertions.assertEquals("U", priv.getPriv_mode());
		var len = result.length.get(0);
		Assertions.assertEquals("MXLEN", len.getLength());
		var desc = result.description.get(0);
		Assertions.assertEquals("Contains aliases to vxrm and vxsat CSRs", desc.getDescription());
		var def = result.definedBy.get(0);
		Assertions.assertEquals("V", def.getExtension_name());
		
		// test fields
		
//		var field0 = result.fields.get(0);
//		var field1 = result.fields.get(1);
//		Assertions.assertEquals("VXRM", field0.name)
		
	}
	

	@Test
	def void rejectsBadHex() throws Exception {

	    
	}
	
	
}