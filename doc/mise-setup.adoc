= Using mise for Tool Version Management

== Overview

The RISC-V Unified Database uses https://mise.jdx.dev[mise] to manage tool versions (Ruby, Node.js, Python) within the container environment. This provides:

* **Consistent versions** across development, CI, and production
* **Automatic tool installation** without manual compilation
* **Fix for Podman UID/GID issues** through newer npm versions
* **Future extensibility** for additional tools and languages

== Container Usage

When using Docker, Podman, or Singularity containers, mise is already configured and all tools are pre-installed. No additional setup is required.

== Native Development Setup (Optional)

If you prefer to develop natively without containers:

. Install mise:
+
[source,bash]
----
curl https://mise.run | sh
----

. Activate mise in your shell (add to `.bashrc` or `.zshrc`):
+
[source,bash]
----
eval "$(mise activate bash)"  # or 'zsh', 'fish', etc.
----

. Install tools:
+
[source,bash]
----
cd /path/to/riscv-unified-db
mise install
----

. Verify installation:
+
[source,bash]
----
mise doctor
ruby --version
node --version
python3 --version
----

== Configuration Files

* `.mise.toml` - Global tool version configuration
* `.mise.local.toml` - Local overrides (gitignored)
* `.ruby-version` - Ruby version specification (referenced by mise)

== Tool Versions

Current versions managed by mise:

* **Ruby**: 3.4.8 (from `.ruby-version`)
* **Node.js**: 22.12.0 (includes npm >= 10.2.0 with Podman fix)
* **Python**: 3.12

== Updating Tool Versions

To update a tool version:

. Edit `.mise.toml`:
+
[source,toml]
----
[tools]
node = "23.0.0"  # Update to newer version
----

. Update the container tag in `bin/.container-tag`

. Rebuild containers:
+
[source,bash]
----
./bin/build_container
----

== Troubleshooting

=== Tools not found

Ensure mise shims are in your PATH:

[source,bash]
----
export PATH="$HOME/.local/share/mise/shims:$PATH"
----

=== Version mismatch

Force reinstall:

[source,bash]
----
mise install --force
mise reshim
----

=== Container issues

Update to the latest container:

[source,bash]
----
# Update container tag
echo "0.16" > bin/.container-tag

# For Docker/Podman
docker pull riscvintl/udb:0.16

# For Singularity
rm -rf .singularity/
./bin/build_container
----

== Benefits Over Previous Approach

.Comparison
[%header,cols="1,1,1"]
|===
|Aspect |Previous (Manual) |New (mise)

|Ruby Installation
|Manual ruby-build compilation
|Automatic via mise

|Node/npm Installation
|System package (old npm)
|Latest LTS with fixed npm

|Python Installation
|System package + venv
|Version-controlled via mise

|Podman Compatibility
|UID/GID issues
|âœ“ Fixed with modern npm

|Version Updates
|Edit Dockerfile, rebuild
|Edit .mise.toml, rebuild

|Local Development
|Complex setup
|`mise install`

|Tool Discovery
|Implicit in Dockerfile
|Explicit in .mise.toml
|===

== Future Enhancements

With mise in place, we can explore:

* **Task runner**: Replace some Rakefile tasks with `mise tasks`
* **Environment management**: Better control of env vars per tool
* **Plugin ecosystem**: Easy addition of new tools (Go, Rust, etc.)
* **IDE integration**: Better tooling support in editors

== Podman UID/GID Issue Resolution

The original issue occurred because older versions of npm (< 10.2.0) preserved UID/GID metadata from the build system when installing packages. Podman, unlike Docker, validates these UIDs/GIDs against the user namespace, causing errors like:

----
Error: potentially insufficient UIDs or GIDs available in user namespace
----

By using mise to install Node.js 22.12.0, we get npm >= 10.2.0 which includes the fix from https://github.com/npm/cli/pull/5998[npm/cli#5998]. This ensures packages are installed with proper ownership that works across different container runtimes.

== References

* https://mise.jdx.dev[mise documentation]
* https://github.com/npm/cli/pull/5998[npm UID/GID fix]
* link:../README.adoc[Main README]
